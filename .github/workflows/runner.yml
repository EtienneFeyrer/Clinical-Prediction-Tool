---
name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    services:
      mariadb:
        image: mariadb:10.6
        env:
          MYSQL_ROOT_PASSWORD: root_password_2024
          MYSQL_DATABASE: AnnotationCache
          MYSQL_USER: annotation_user
          MYSQL_PASSWORD: secure_pass_2024
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install --upgrade pytest nbval
          pip install -r requirements.txt

      - name: Wait for MariaDB
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client
          until mysql -h 127.0.0.1 -u annotation_user -psecure_pass_2024 AnnotationCache -e "SELECT 1"; do
            echo "Waiting for MariaDB..."
            sleep 2
          done

      - name: Set up database schema
        run: |
          mysql -h 127.0.0.1 -u annotation_user -psecure_pass_2024 AnnotationCache << 'EOF'
          
          CREATE TABLE IF NOT EXISTS Annotation (
          Annotation_id INT AUTO_INCREMENT PRIMARY KEY,
            variant_id VARCHAR(255) UNIQUE NOT NULL,
            gene VARCHAR(255),
            allele_freq FLOAT,
            CADD FLOAT,
            OMIM VARCHAR(255),
            max_allele_freq FLOAT,
            ML_score FLOAT,
            most_severe_consequence VARCHAR(255),
            CLINSIG VARCHAR(500)
          );
          
          CREATE TABLE IF NOT EXISTS Transcript (
            id INT AUTO_INCREMENT PRIMARY KEY,
            variant_id VARCHAR(255) NOT NULL,
            transcript_id VARCHAR(255),
            polyphen FLOAT,
            protein_notation VARCHAR(255),
            REVEL FLOAT,
            Splice_AI FLOAT,
            Mane BOOLEAN DEFAULT FALSE,
            LOFTEE VARCHAR(255),
            impact VARCHAR(255),
            GERP FLOAT,
            cDNA_notation VARCHAR(255),
            consequences TEXT,
            FOREIGN KEY (variant_id) REFERENCES Annotation(variant_id)
          );

          EOF

      - name: Start API server in background
        run: |
          python -m api.server &
          API_PID=$!
          echo "API_PID=$API_PID" >> $GITHUB_ENV
          
          # Wait for server to start
          for i in {1..30}; do
            if curl -s http://localhost:5001/health > /dev/null; then
              echo "API server is ready"
              break
            fi
            echo "Waiting for API server... ($i/30)"
            sleep 2
          done
        env:
          DB_HOST: 127.0.0.1
          DB_USER: annotation_user
          DB_PASSWORD: secure_pass_2024
          DB_NAME: AnnotationCache

      - name: Test API endpoints
        run: |
          # Test health endpoint
          curl -f http://localhost:5001/health
          
          # Test statistics endpoint
          curl -f http://localhost:5001/statistics
          
          # Run your testing script
          python testing/testing_small.py
        timeout-minutes: 5
        env:
          DB_HOST: 127.0.0.1
          DB_USER: annotation_user
          DB_PASSWORD: secure_pass_2024
          DB_NAME: AnnotationCache

      - name: Print pytest version
        run: pytest --version

      - name: Test Python files (fail only if real test fails)
        run: |
          set +e
          pytest
          code=$?
          if [ $code -ne 0 ] && [ $code -ne 5 ] && [ $code -ne 4 ]; then
            exit $code
          fi
        env:
          DB_HOST: 127.0.0.1
          DB_USER: annotation_user
          DB_PASSWORD: secure_pass_2024
          DB_NAME: AnnotationCache

      - name: Test all Jupyter notebooks (fail only if real test fails)
        run: |
          set +e
          pytest --nbval -- ./**/*.ipynb
          code=$?
          if [ $code -ne 0 ] && [ $code -ne 5 ] && [ $code -ne 4 ]; then
            exit $code
          fi

      - name: Cleanup
        if: always()
        run: |
          # Kill API server if it's still running
          if [ -n "$API_PID" ]; then
            echo "Stopping API server (PID: $API_PID)"
            kill $API_PID || true
          fi
          
          # Clean up any remaining python processes
          pkill -f "python -m api.server" || true
